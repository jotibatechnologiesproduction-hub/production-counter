<script>
let port;
let reader;

async function connectSerial() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });

    document.getElementById("status").innerText = "Connected";

    reader = port.readable.getReader();
    readSerial();
  } catch (err) {
    alert("Serial connection failed");
  }
}

async function readSerial() {
  let buffer = "";
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;

    buffer += new TextDecoder().decode(value);
    let lines = buffer.split("\n");

    buffer = lines.pop();

    for (let line of lines) {
      processData(line.trim());
    }
  }
}

function processData(data) {
  if (data.startsWith("CNC1=")) {
    let count = data.split("=")[1];
    document.getElementById("cnc1Actual").innerText = count;
  }
}
</script>
